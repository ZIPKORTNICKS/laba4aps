 <!HTML>
 <html>
 <head>
 <title>Загрузчик файлов</title>
 </head>
 <a href="loginka.html" id="logout">Login with google</a>
 <a href="">Log out</a>
 <div class="form-group row">
    <label class="col-sm-2 col-form-label" id="">Email</label>
    <div class="col-sm-10">
      <input type="email" class="form-control" id="inputEmail3" placeholder="Email">
    </div>
  </div>
  
  	<script>
			// initialissation user data
			var globalFile='';
			var globalUser = JSON.parse( localStorage.getItem('user'));
			var globalToken = localStorage.getItem('token');

			if(globalUser&&globalToken){
				$('#profileselector').text(globalUser.displayName);
			}else{
				alert('авторизируйтесь на сайте для начала работы!');
			}
			
			console.log(globalToken);
			console.log(globalUser);

			// Initialize Firebase
			var config = {
				apiKey: "AIzaSyAXLU6tV2AYec1RYKKWqr5xzy-XAyl5sLw",
				authDomain: "lab4-1d5f4.firebaseapp.com",
				databaseURL: "https://lab4-1d5f4.firebaseio.com",
				projectId: "lab4-1d5f4",
				storageBucket: "lab4-1d5f4.appspot.com",
				messagingSenderId: "718929728498"
			};
			firebase.initializeApp(config);
			
			// Get a reference to the storage service, which is used to create references in your storage bucket
			var storage = firebase.storage();
			
			// Create a child reference
			var storageRef = firebase.storage().ref();
			
			$('#sendData').click(function(){
							
				var message = "test message";
				
				const metadata = { contentType: globalFile.type };
				var filename = globalFile.name;
				const ref = firebase.storage().ref('/images/'+filename);
				var uploadTask = ref.put(globalFile, metadata);
				
				// Register three observers:
				// 1. 'state_changed' observer, called any time the state changes
				// 2. Error observer, called on failure
				// 3. Completion observer, called on successful completion
				uploadTask.on('state_changed', function(snapshot){
					// Observe state change events such as progress, pause, and resume
					// Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
					var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
					console.log('Upload is ' + progress + '% done');
					switch (snapshot.state) {
						case firebase.storage.TaskState.PAUSED: // or 'paused'
						console.log('Upload is paused');
						break;
						case firebase.storage.TaskState.RUNNING: // or 'running'
						console.log('Upload is running');
						break;
					}
				}, function(error) {
					// Handle unsuccessful uploads
				}, function() {
					// Handle successful uploads on complete
					// For instance, get the download URL: https://firebasestorage.googleapis.com/...
					var downloadURL = uploadTask.snapshot.downloadURL;
					console.log(downloadURL);
				});
				
				
				firebase.database().ref('text_data').set({
					text: 'test text message',
				});
				
			});
			// Sign - in ----------------------------------------------------------------
			function signIn(){
				var provider = new firebase.auth.GoogleAuthProvider();
				provider.addScope('https://www.googleapis.com/auth/contacts.readonly');
				//firebase.auth().signInWithRedirect(provider);
				firebase.auth().signInWithPopup(provider).then(function(result) {
					// This gives you a Google Access Token. You can use it to access the Google API.
					var token = result.credential.accessToken;
					// The signed-in user info.
					var user = result.user;
									
					globalToken=token;
					globalUser=user;
					$('#profileselector').text(globalUser.displayName);
					
					localStorage.setItem('user', JSON.stringify(globalUser));
					localStorage.setItem('token', globalToken);
					
					console.log('token '+ globalToken);
					
				}).catch(function(error) {
					// Handle Errors here.
					var errorCode = error.code;
					var errorMessage = error.message;
					// The email of the user's account used.
					var email = error.email;
					// The firebase.auth.AuthCredential type that was used.
					var credential = error.credential;
				});
			}
			// Sign - out ----------------------------------------------------------------
			$('#logout').click(function(){
				localStorage.clear();
				globalToken='';
				globalUser = '';
				firebase.auth().signOut().then(function() {
					console.log( 'Sign-out successful');
				}).catch(function(error) {
					// An error happened.
				});
			});

			// file selector ------------------------------------------------------------
			function handleFileSelect(evt) {
				var files = evt.target.files; // FileList object
				globalFile = files[0];
				// files is a FileList of File objects. List some properties.
				var output = [];
				for (var i = 0, f; f = files[i]; i++) {
					output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
						f.size, ' bytes, last modified: ',
						f.lastModifiedDate.toLocaleDateString(), '</li>');
					}
					document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
				}
				
				document.getElementById('files').addEventListener('change', handleFileSelect, false);
				
			</script>
  </html>
  
  	